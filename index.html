<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Warehouse Picking Map</title>
    <link rel="stylesheet" href="./styles.css?v=5">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1> B4 Extension Map</h1>
            <div class="header-actions">
                <button class="btn" id="exportImageBtn" style="display:none;">üì∑ Export Image</button>
                <button class="btn" id="exportExcelBtn" style="display:none;">üìä Export Metrics</button>
            </div>
        </div>
        
        <div class="upload-section">
            <div class="upload-cards">
                <div class="upload-card" id="locationUploadBox">
                    <div class="upload-card-icon">üìç</div>
                    <div class="upload-card-title">Location Master</div>
                    <div class="upload-card-desc">Upload layout (.xlsx/.xls)</div>
                    <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls">
                </div>
                <div class="upload-card" id="routeUploadBox">
                    <div class="upload-card-icon">üõ§Ô∏è</div>
                    <div class="upload-card-title">Route Data</div>
                    <div class="upload-card-desc">Upload routes (.xlsx/.xls)</div>
                    <input type="file" id="routeFileInput" class="file-input" accept=".xlsx,.xls">
                </div>
            </div>
        </div>

        <!-- Column Mapping -->
        <div id="columnMappingSection">
            <div class="mapping-header">
                <span style="font-size:20px;"></span>
                <h3>Column Mapping</h3>
            </div>
            <div class="mapping-grid">
                <div class="mapping-field">
                    <label>Wave_path/Picker Column:</label>
                    <select id="colWave"><option value="">-- Select --</option></select>
                    <small>Identifies wave paths or pickers</small>
                </div>
                <div class="mapping-field">
                    <label>Pick Time Column:</label>
                    <select id="colTime"><option value="">-- Select --</option></select>
                    <small>For sorting route order</small>
                </div>
                <div class="mapping-field">
                    <label>Location Column: <span style="color:#e74c3c;">*</span></label>
                    <select id="colLocation"><option value="">-- Select --</option></select>
                    <small>Required - location identifier</small>
                </div>
                <div class="mapping-field">
                    <label>Aisle Column:</label>
                    <select id="colAisle"><option value="">-- None --</option></select>
                    <small>For tracking aisle crosses</small>
                </div>
                <div class="mapping-field">
                    <label>SKU Column: <span style="color:#e74c3c;">*</span></label>
                    <select id="colSku"><option value="">-- Select --</option></select>
                    <small>Required - SKU identifier</small>
                </div>
            </div>
            <div style="display:flex; gap:15px; align-items:center;">
                <button class="btn btn-success" id="confirmMappingBtn">‚úì Confirm & Process</button>
                <span id="mappingStatus" style="color:rgba(255,255,255,0.6); font-size:13px;"></span>
            </div>
            <div id="previewSection">
                <h4 style="color:#fff; margin-bottom:10px; font-size:13px;">Data Preview:</h4>
                <div id="previewTable"></div>
            </div>
        </div>
        
        <div class="controls" id="controls">
            <div class="control-group">
                <label>üîç Search:</label>
                <input type="text" id="searchInput" placeholder="Location..." style="width:120px;">
            </div>
            <div class="control-group">
                <label>üìç Zone:</label>
                <select id="zoneFilter" style="width:100px;"><option value="">All</option></select>
            </div>
            <div class="control-group">
                <label>üîé Zoom:</label>
                <input type="range" id="zoomSlider" min="0.3" max="4" step="0.1" value="1" style="width:80px;">
            </div>
            <div class="control-group">
                <button class="btn btn-sm" id="shortcutsBtn" title="Press ? to show shortcuts">‚å®Ô∏è Shortcuts</button>
            </div>
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-label">Shelves</div>
                    <div class="stat-value" id="totalShelves">0</div>
                </div>
            </div>
        </div>

        <!-- Wave Controls -->
        <div class="wave-controls" id="waveControls">
            <div class="multi-select-wrapper">
                <div class="multi-select-btn" id="multiSelectBtn">Select Wave Paths (0)</div>
                <div class="multi-select-dropdown" id="multiSelectDropdown"></div>
                <div class="multi-select-actions">
                    <button class="btn btn-sm" id="selectAllWavesBtn">Select All</button>
                    <button class="btn btn-sm btn-danger" id="clearWavesBtn">Clear</button>
                </div>
            </div>

            <div class="multi-select-wrapper">
                <div class="multi-select-btn abnormal-btn" id="abnormalWavesBtn">
                    üö® Check Abnormal Wave (0)
                </div>
                <div class="multi-select-dropdown" id="abnormalDropdown">
                    <div class="abnormal-filters">
                        <label class="filter-checkbox">
                            <input type="checkbox" id="filterSlot" checked>
                            <span>Slot Revisit</span>
                        </label>
                        <label class="filter-checkbox">
                            <input type="checkbox" id="filterShelf" checked>
                            <span>Shelf Revisit</span>
                        </label>
                        <label class="filter-checkbox">
                            <input type="checkbox" id="filterAisle" checked>
                            <span>Aisle Revisit</span>
                        </label>
                    </div>
                    <div class="abnormal-divider"></div>
                    <div id="abnormalWavesList"></div>
                    <div class="multi-select-actions">
                        <button class="btn btn-sm" id="selectAllAbnormalBtn">Select All Abnormal</button>
                    </div>
                </div>
            </div>
            
            <div class="mode-toggle">
                <button class="mode-btn active" data-mode="route">Route</button>
                <button class="mode-btn" data-mode="heatmap">Heatmap</button>
            </div>

            <div class="control-group">
                <button class="btn btn-sm" id="toggleZonesBtn" title="Toggle zone background overlay">
                    üìç Show Zones
                </button>
            </div>
            
            <div class="playback-section">
                <div class="playback-btns">
                    <button class="btn btn-sm" id="playBtn">‚ñ∂</button>
                    <button class="btn btn-sm btn-warning" id="pauseBtn" style="display:none;">‚è∏</button>
                    <button class="btn btn-sm btn-danger" id="stopBtn">‚èπ</button>
                </div>
                <div class="progress-slider-wrapper">
                    <input type="range" class="progress-slider" id="progressSlider" min="0" max="100" value="0">
                    <span class="progress-label" id="progressLabel">0 / 0</span>
                </div>
            </div>
            
            <div class="control-group">
                <label>Speed:</label>
                <input type="range" id="speedSlider" min="50" max="1000" step="50" value="400" style="width:80px;">
                <span id="speedValue" style="color:rgba(255,255,255,0.5);font-size:11px;">400ms</span>
            </div>
        </div>

        <!-- Metrics Panel (Above Map) -->
        <div class="metrics-panel" id="metricsPanel">
            <div class="metrics-header">
                <h3>üìä Route Metrics</h3>
            </div>

            <!-- P0: Core Efficiency Metrics -->
            <div class="metrics-section">
                <h4 class="metrics-section-title">‚ö° Core Efficiency</h4>
                <div class="metrics-grid">
                    <div class="metric-card success">
                        <div class="metric-label">Pick Rate</div>
                        <div class="metric-value" id="metricPickRate">0</div>
                        <div class="metric-subtitle">picks/hour</div>
                    </div>
                    <div class="metric-card info">
                        <div class="metric-label">Distance/Unit</div>
                        <div class="metric-value" id="metricDistancePerUnit">0</div>
                        <div class="metric-subtitle">meters/pick</div>
                    </div>
                    <div class="metric-card success">
                        <div class="metric-label">Path Efficiency</div>
                        <div class="metric-value" id="metricPathEfficiency">0%</div>
                        <div class="metric-subtitle">vs optimal</div>
                    </div>
                </div>
            </div>

            <!-- P1: Quality Metrics -->
            <div class="metrics-section">
                <h4 class="metrics-section-title">üìà Quality Metrics</h4>
                <div class="metrics-grid">
                    <div class="metric-card info">
                        <div class="metric-label">Travel Speed</div>
                        <div class="metric-value" id="metricTravelSpeed">0</div>
                        <div class="metric-subtitle">m/min</div>
                    </div>
                    <div class="metric-card danger">
                        <div class="metric-label">Wasted Distance</div>
                        <div class="metric-value" id="metricWastedDistance">0 m</div>
                        <div class="metric-subtitle">excess travel</div>
                    </div>
                    <div class="metric-card warning">
                        <div class="metric-label">Revisit Rate</div>
                        <div class="metric-value" id="metricRevisitRate">0%</div>
                        <div class="metric-subtitle">of total picks</div>
                    </div>
                </div>
            </div>

            <!-- Existing: Issue Detection -->
            <div class="metrics-section">
                <h4 class="metrics-section-title">üö® Issue Detection</h4>
                <div class="metrics-grid">
                    <div class="metric-card warning clickable" id="locationCrossCard">
                        <div class="metric-label">Slot Revisit</div>
                        <div class="metric-value" id="metricLocationCrosses">0</div>
                        <div class="metric-subtitle">revisit count</div>
                    </div>
                    <div class="metric-card warning clickable" id="locationCrossBayCard">
                        <div class="metric-label">Shelf Revisit</div>
                        <div class="metric-value" id="metricLocationCrossesBay">0</div>
                        <div class="metric-subtitle">revisit count</div>
                    </div>
                    <div class="metric-card danger clickable" id="aisleCrossCard">
                        <div class="metric-label">Aisle Revisit</div>
                        <div class="metric-value" id="metricAisleCrosses">0</div>
                        <div class="metric-subtitle">revisit count</div>
                    </div>
                </div>
            </div>

            <!-- Existing: Basic Statistics -->
            <div class="metrics-section">
                <h4 class="metrics-section-title">üìã Statistics</h4>
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-label">Current Unit</div>
                        <div class="metric-value" id="metricCurrentUnit">0</div>
                        <div class="metric-subtitle" id="metricTotalUnits">of 0 total</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Route Distance</div>
                        <div class="metric-value" id="metricDistance">0 m</div>
                        <div class="metric-subtitle">meters</div>
                    </div>
                    <div class="metric-card info">
                        <div class="metric-label">Total Time</div>
                        <div class="metric-value" id="metricTotalTime">0:00</div>
                        <div class="metric-subtitle">picking duration</div>
                    </div>
                    <div class="metric-card info">
                        <div class="metric-label">Avg Time/Unit</div>
                        <div class="metric-value" id="metricAvgTime">0s</div>
                        <div class="metric-subtitle">per location</div>
                    </div>
                    <div class="metric-card info">
                        <div class="metric-label">Pick Speed</div>
                        <div class="metric-value" id="metricPickSpeed">0</div>
                        <div class="metric-subtitle">units/min</div>
                    </div>
                </div>
            </div>

            <!-- SKU Statistics Section (Bottom with collapse) -->
            <div class="sku-stats-section" id="skuStatsSection">
                <div class="sku-stats-header">
                    <h4>üì¶ SKU Statistics</h4>
                    <div class="sku-stats-controls">
                        <span class="sku-count" id="skuCount">0 SKUs</span>
                        <button class="btn btn-sm sku-toggle-btn" id="skuToggleBtn">
                            <span class="toggle-icon">‚ñº</span> Expand
                        </button>
                    </div>
                </div>
                <div class="sku-stats-list collapsed" id="skuStatsList">
                    <div class="sku-stats-empty">No SKU data available</div>
                </div>
            </div>
        </div>

        <!-- Hourly Performance Chart -->
        <div class="hourly-performance-section" id="hourlyPerformanceSection">
            <div class="hourly-performance-header">
                <h3>üìà Hourly Performance</h3>
                <button class="btn btn-sm hourly-toggle-btn" id="hourlyToggleBtn">
                    <span class="toggle-icon">‚ñº</span> Expand
                </button>
            </div>
            <div class="hourly-performance-content collapsed" id="hourlyPerformanceContent">
                <div class="time-range-controls">
                    <div class="time-range-group">
                        <label>Start Hour:</label>
                        <input type="range" id="startHourSlider" min="0" max="23" value="0" step="1">
                        <span id="startHourLabel">00:00</span>
                    </div>
                    <div class="time-range-group">
                        <label>End Hour:</label>
                        <input type="range" id="endHourSlider" min="0" max="23" value="23" step="1">
                        <span id="endHourLabel">23:00</span>
                    </div>
                    <div class="time-range-stats">
                        <span id="avgPicksLabel">Avg: 0 picks/hour</span>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="hourlyChart"></canvas>
                </div>
            </div>
        </div>

        <div class="map-container" id="mapContainer">
            <div class="canvas-wrapper">
                <canvas id="mapCanvas"></canvas>
                <div class="tooltip" id="tooltip"></div>
            </div>
        </div>

        <!-- Wave Comparison Table -->
        <div class="comparison-table-section" id="comparisonTableSection">
            <div class="table-header">
                <h3>üìä Wave Comparison Analysis</h3>
                <div class="table-actions">
                    <button class="btn btn-sm" id="exportTableBtn">üìã Export Table</button>
                </div>
            </div>
            <div class="table-wrapper">
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th class="sortable" data-sort="waveId">Wave ID ‚ñº</th>
                            <th class="sortable" data-sort="units">Units</th>
                            <th class="sortable" data-sort="distance">Distance (m)</th>
                            <th class="sortable" data-sort="time">Duration</th>
                            <th class="sortable" data-sort="revisits">Total Revisits</th>
                            <th class="sortable" data-sort="speed">Speed (u/min)</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="comparisonTableBody">
                        <tr>
                            <td colspan="7" class="table-empty">Select waves to see comparison data</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Aisle/Location Detail Modal -->
    <div class="modal-overlay" id="detailModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modalTitle">Details</h3>
                <button class="modal-close" onclick="closeModal()">√ó</button>
            </div>
            <div class="modal-body">
                <ul class="detail-list" id="detailList"></ul>
            </div>
        </div>
    </div>
    
    <div class="info-panel" id="infoPanel">
        <div class="info-header">
            <h2>üì¶ Shelf Details</h2>
            <button class="close-btn" onclick="closeInfoPanel()">√ó</button>
        </div>
        <div class="info-content" id="infoContent"></div>
    </div>

<script type="module" src="./app.js?v=5"></script>
</body>
</html>
